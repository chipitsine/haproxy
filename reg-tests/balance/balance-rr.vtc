vtest "Test for balance roundrobin"
feature ignore_unknown_macro

server s1 {
    rxreq
    txresp -hdr "Server: s1"
} -repeat 2 -start

server s2 {
    rxreq
    txresp -hdr "Server: s2"
} -repeat 2 -start

server s3 {
    rxreq
    txresp -hdr "Server: s3"
} -repeat 2 -start

server s4 {
    rxreq
    txresp -hdr "Server: s4"
} -repeat 2 -start

haproxy h1 -arg "-L A" -conf {
    defaults
        mode http
        timeout server "${HAPROXY_TEST_TIMEOUT-5s}"
        timeout connect "${HAPROXY_TEST_TIMEOUT-5s}"
        timeout client "${HAPROXY_TEST_TIMEOUT-5s}"

    listen px
        bind "fd@${px}"
        balance roundrobin
        server srv1 ${s1_addr}:${s1_port}
        server srv2 ${s2_addr}:${s2_port}
        server srv3 ${s3_addr}:${s3_port}
        server srv4 ${s4_addr}:${s4_port}

    .if feature(PROMEX)
    frontend prometheus
        bind "fd@${prometheus}"
        mode http
        http-request use-service prometheus-exporter
        no log
    .endif

} -start

client c1 -connect ${h1_px_sock} {
    txreq -url "/url1"
    rxresp
    expect resp.status == 200
    expect resp.http.Server ~ s1
} -run

client c2 -connect ${h1_px_sock} {
    txreq -url "/url1"
    rxresp
    expect resp.status == 200
    expect resp.http.Server ~ s2
} -run

client c3 -connect ${h1_px_sock} {
    txreq -url "/url1"
    rxresp
    expect resp.status == 200
    expect resp.http.Server ~ s3
} -run

client c4 -connect ${h1_px_sock} {
    txreq -url "/url1"
    rxresp
    expect resp.status == 200
    expect resp.http.Server ~ s4
} -run

client c5 -connect ${h1_px_sock} {
    txreq -url "/url1"
    rxresp
    expect resp.status == 200
    expect resp.http.Server ~ s1
} -run

shell {
    if [ ! -z ${h1_prometheus_addr+x} ]; then
        HOST=${h1_fe1_addr}
        if [ "${h1_fe1_addr}" = "::1" ] ; then
            HOST="\[::1\]"
        fi
        curl -i -k https://$HOST:${h1_prometheus_port} | prom/promtool check metrics
    fi
}